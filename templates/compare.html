{% extends "base.html" %}

{% block title %}Comparar Artigo - Medium to WordPress{% endblock %}

{% block extra_css %}
<style>
    .compare-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    
    .compare-column {
        flex: 1;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .compare-header {
        position: sticky;
        top: -20px;
        background: white;
        padding: 15px 0;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
        z-index: 10;
    }
    
    .article-content img {
        max-width: 100%;
        height: auto;
        margin: 15px 0;
        border-radius: 5px;
    }
    
    .metadata-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .action-bar {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 20px;
        border-top: 2px solid #e0e0e0;
        margin: 0 -20px -20px;
    }
    
    .image-gallery {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 10px 0;
        margin: 15px 0;
    }
    
    .image-thumbnail {
        min-width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .image-thumbnail:hover {
        transform: scale(1.05);
    }
    
    .version-label {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .original-label {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .translated-label {
        background: #e8f5e9;
        color: #388e3c;
    }
    
    @media (max-width: 768px) {
        .compare-container {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h3>üìë Compara√ß√£o de Artigo</h3>
                <div>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar ao Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    {% if comparison %}
        <!-- Metadata Section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="metadata-box">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Autor:</strong> {{ comparison.original.author }}
                        </div>
                        <div class="col-md-3">
                            <strong>Tempo de Leitura:</strong> {{ comparison.metadata.reading_time }} min
                        </div>
                        <div class="col-md-3">
                            <strong>Claps:</strong> {{ comparison.metadata.claps|default(0) }}
                        </div>
                        <div class="col-md-3">
                            <strong>Cache Expira:</strong> {{ comparison.metadata.expires_at[:10] if comparison.metadata.expires_at else 'N/A' }}
                        </div>
                    </div>
                    {% if comparison.metadata.tags %}
                        <div class="mt-2">
                            <strong>Tags:</strong>
                            {% for tag in comparison.metadata.tags %}
                                <span class="badge bg-secondary ms-1">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="mt-2">
                        <a href="{{ comparison.metadata.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Ver no Medium
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cover Image -->
        {% if comparison.original.cover_image %}
            <div class="row mb-3">
                <div class="col-12 text-center">
                    <img src="{{ comparison.original.cover_image }}" 
                         alt="Cover" 
                         style="max-width: 100%; max-height: 400px; border-radius: 10px;">
                </div>
            </div>
        {% endif %}
        
        <!-- Image Gallery (if multiple images) -->
        {% if comparison.original.images and comparison.original.images|length > 1 %}
            <div class="row mb-3">
                <div class="col-12">
                    <h5>üì∑ Imagens no Artigo ({{ comparison.original.images|length }})</h5>
                    <div class="image-gallery">
                        {% for image in comparison.original.images %}
                            <img src="{{ image }}" 
                                 class="image-thumbnail" 
                                 onclick="showImageModal('{{ image }}')"
                                 alt="Image {{ loop.index }}">
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Comparison Columns -->
        <div class="compare-container">
            <!-- Original Column -->
            <div class="compare-column">
                <div class="compare-header">
                    <span class="version-label original-label">VERS√ÉO ORIGINAL</span>
                    <h4 class="mt-2">{{ comparison.original.title }}</h4>
                    {% if comparison.original.subtitle %}
                        <p class="text-muted">{{ comparison.original.subtitle }}</p>
                    {% endif %}
                </div>
                
                <div class="article-content">
                    {{ comparison.original.content|safe }}
                </div>
            </div>
            
            <!-- Translated Column -->
            <div class="compare-column">
                <div class="compare-header">
                    <span class="version-label translated-label">VERS√ÉO TRADUZIDA</span>
                    {% if comparison.translated.title %}
                        <h4 class="mt-2">{{ comparison.translated.title }}</h4>
                        {% if comparison.translated.subtitle %}
                            <p class="text-muted">{{ comparison.translated.subtitle }}</p>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Este artigo ainda n√£o foi traduzido.
                            <button class="btn btn-sm btn-success ms-2" onclick="translateNow()">
                                <i class="bi bi-translate"></i> Traduzir Agora
                            </button>
                        </div>
                    {% endif %}
                </div>
                
                <div class="article-content">
                    {% if comparison.translated.content %}
                        {{ comparison.translated.content|safe }}
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-translate" style="font-size: 3rem;"></i>
                            <p class="mt-3">Clique em "Traduzir Agora" para gerar a vers√£o em portugu√™s</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if comparison.translated.content %}
                                <span class="text-success">
                                    <i class="bi bi-check-circle"></i> Tradu√ß√£o Pronta
                                </span>
                            {% else %}
                                <span class="text-warning">
                                    <i class="bi bi-exclamation-circle"></i> Aguardando Tradu√ß√£o
                                </span>
                            {% endif %}
                        </div>
                        <div>
                            {% if comparison.translated.content %}
                                <button class="btn btn-success" onclick="publishToWordPress()">
                                    <i class="bi bi-wordpress"></i> Publicar no WordPress
                                </button>
                                <button class="btn btn-outline-primary ms-2" onclick="retranslate()">
                                    <i class="bi bi-arrow-clockwise"></i> Retraduzir
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Artigo n√£o encontrado ou erro ao carregar.
        </div>
    {% endif %}
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Visualizar Imagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" style="max-width: 100%;">
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Processando...</span>
                </div>
                <p class="mt-2 mb-0" id="loadingText">Processando...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const mediumId = '{{ comparison.medium_id if comparison else "" }}';

function showImageModal(imageUrl) {
    document.getElementById('modalImage').src = imageUrl;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function translateNow() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    document.getElementById('loadingText').textContent = 'Traduzindo artigo...';
    modal.show();
    
    fetch(`/api/translate/${mediumId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                modal.hide();
                showAlert('Erro ao traduzir: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            modal.hide();
            showAlert('Erro ao traduzir artigo', 'danger');
        });
}

function retranslate() {
    if (confirm('Deseja retraduzir este artigo? A tradu√ß√£o atual ser√° substitu√≠da.')) {
        translateNow();
    }
}

function publishToWordPress() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    document.getElementById('loadingText').textContent = 'Publicando no WordPress...';
    modal.show();
    
    fetch(`/api/publish/${mediumId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            modal.hide();
            if (data.success) {
                showAlert('Artigo publicado com sucesso!', 'success');
                if (data.wordpress_url) {
                    setTimeout(() => {
                        window.open(data.wordpress_url, '_blank');
                    }, 1500);
                }
            } else {
                showAlert('Erro ao publicar: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            modal.hide();
            showAlert('Erro ao publicar artigo', 'danger');
        });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

// Sync scroll between columns
document.addEventListener('DOMContentLoaded', function() {
    const columns = document.querySelectorAll('.compare-column');
    let syncing = false;
    
    columns.forEach((column, index) => {
        column.addEventListener('scroll', function() {
            if (!syncing) {
                syncing = true;
                const scrollPercent = this.scrollTop / (this.scrollHeight - this.clientHeight);
                
                columns.forEach((otherColumn, otherIndex) => {
                    if (index !== otherIndex) {
                        const targetScroll = scrollPercent * (otherColumn.scrollHeight - otherColumn.clientHeight);
                        otherColumn.scrollTop = targetScroll;
                    }
                });
                
                setTimeout(() => syncing = false, 10);
            }
        });
    });
});
</script>
{% endblock %}