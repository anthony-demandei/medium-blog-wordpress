{% extends "base.html" %}

{% block title %}Dashboard - Medium to WordPress{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_articles }}</div>
        <div class="stat-label">Artigos Publicados</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ stats.synced_articles }}</div>
        <div class="stat-label">Artigos Sincronizados</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ stats.sync_success_rate }}%</div>
        <div class="stat-label">Taxa de Sucesso</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Próxima Sincronização</div>
        <div class="text-small text-muted">{{ next_sync if next_sync else 'Não agendado' }}</div>
    </div>
</div>

{% if not is_configured %}
<div class="alert alert-warning">
    <strong>Configuração Necessária</strong><br>
    Configure as seguintes variáveis no arquivo .env:
    <ul class="mb-1 mt-2">
        {% for error in config_errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- API Usage -->
{% if api_usage %}
<div class="card">
    <div class="card-header">
        <span class="card-title">Uso da API Medium</span>
        <span class="status-badge status-{% if api_stats.critical_level %}error{% elif api_stats.warning_level %}warning{% else %}success{% endif %}">
            {{ api_usage.requests_used }} / {{ api_usage.requests_limit }}
        </span>
    </div>
    <div class="article-meta">
        <span>Mês: {{ api_usage.month }}</span>
        <span>Média diária: {{ api_stats.daily_average }} req/dia</span>
        <span>Projeção: {{ api_stats.projected_monthly }} requisições</span>
        <span>Restantes: {{ api_usage.requests_remaining }}</span>
    </div>
</div>
{% endif %}

<div class="grid grid-2 mt-3">
    <!-- Recent Articles from WordPress -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Posts Recentes do WordPress</span>
            <a href="{{ config.WORDPRESS_URL }}" target="_blank" class="btn btn-sm btn-primary">Ver Blog</a>
        </div>
        
        {% if recent_articles %}
            {% for article in recent_articles %}
                <div class="article-item">
                    <div class="article-title">
                        {{ article.title|safe|striptags|truncate(80) }}
                    </div>
                    <div class="article-meta">
                        <span>{{ article.author }}</span>
                        <span>{{ article.date[:10] if article.date else 'N/A' }}</span>
                        {% if article.categories %}
                            <span style="color: var(--info);">{{ article.categories[0] }}</span>
                        {% endif %}
                        <a href="{{ article.link }}" target="_blank">Ver Post</a>
                    </div>
                    {% if article.excerpt %}
                    <div class="text-small text-muted mt-1">
                        {{ article.excerpt|safe|striptags|truncate(100) }}
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-title">Nenhum post encontrado</div>
                <div class="empty-state-text">Verifique a conexão com o WordPress</div>
                <a href="/settings" class="btn btn-primary mt-2">Verificar Configurações</a>
            </div>
        {% endif %}
    </div>

    <!-- System Status -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Status do Sistema</span>
        </div>
        
        <table>
            <tr>
                <td>Medium API</td>
                <td class="text-right">
                    <span class="status-badge status-success">Conectado</span>
                </td>
            </tr>
            <tr>
                <td>WordPress</td>
                <td class="text-right">
                    <span class="status-badge status-{{ 'success' if config.WORDPRESS_URL else 'warning' }}">
                        {{ 'Conectado' if config.WORDPRESS_URL else 'Configurar' }}
                    </span>
                </td>
            </tr>
            <tr>
                <td>Gemini AI</td>
                <td class="text-right">
                    <span class="status-badge status-{{ 'success' if config.GEMINI_API_KEY else 'info' }}">
                        {{ 'Ativo' if config.GEMINI_API_KEY else 'Desativado' }}
                    </span>
                </td>
            </tr>
        </table>
        
        <div class="mt-3">
            <div class="text-small text-muted mb-2">Palavras-chave Ativas:</div>
            <div class="d-flex gap-1" style="flex-wrap: wrap;">
                {% for keyword in config.SEARCH_KEYWORDS %}
                    <span class="status-badge status-info">{{ keyword }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}