{% extends "base.html" %}

{% block title %}Configurações - Medium to WordPress{% endblock %}

{% block content %}
<form id="settingsForm" onsubmit="return saveSettings()">
    <!-- Medium API -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Medium API</span>
        </div>
        <div class="form-group">
            <label>RapidAPI Key</label>
            <input type="password" name="rapidapi_key" value="{{ settings.get('medium_api', {}).get('rapidapi_key', '') }}" placeholder="Sua chave da RapidAPI" required>
        </div>
        <div class="form-group">
            <label>RapidAPI Host</label>
            <input type="text" name="rapidapi_host" value="{{ settings.get('medium_api', {}).get('rapidapi_host', 'medium2.p.rapidapi.com') }}">
        </div>
    </div>

    <!-- WordPress -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">WordPress</span>
        </div>
        <div class="form-group">
            <label>URL do Site</label>
            <input type="url" name="wordpress_url" value="{{ settings.get('wordpress', {}).get('url', '') }}" placeholder="https://seu-site.com" required>
        </div>
        <div class="form-group">
            <label>Usuário</label>
            <input type="text" name="wordpress_username" value="{{ settings.get('wordpress', {}).get('username', '') }}" placeholder="admin" required>
        </div>
        <div class="form-group">
            <label>Application Password</label>
            <input type="password" name="wordpress_password" value="{{ settings.get('wordpress', {}).get('password', '') }}" placeholder="Senha gerada no WordPress" required>
        </div>
        <div class="form-group">
            <label>Categoria Padrão</label>
            <input type="text" name="default_category" value="{{ settings.get('wordpress', {}).get('default_category', 'Technology') }}" placeholder="Technology">
        </div>
        <div class="form-group">
            <label>Status dos Posts</label>
            <select name="post_status">
                <option value="draft" {% if settings.get('wordpress', {}).get('post_status') == 'draft' %}selected{% endif %}>Rascunho</option>
                <option value="publish" {% if settings.get('wordpress', {}).get('post_status') == 'publish' %}selected{% endif %}>Publicar</option>
            </select>
        </div>
    </div>

    <!-- Gemini AI -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Gemini AI (Tradução)</span>
        </div>
        <div class="form-group">
            <label>API Key</label>
            <input type="password" name="gemini_key" value="{{ settings.get('gemini', {}).get('api_key', '') }}" placeholder="Opcional - para tradução automática">
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="auto_translate" {% if settings.get('content', {}).get('auto_translate', True) %}checked{% endif %}>
                Traduzir automaticamente para português
            </label>
        </div>
    </div>

    <!-- Busca -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Configuração de Busca</span>
        </div>
        <div class="form-group">
            <label>Palavras-chave</label>
            <textarea name="keywords" rows="3" placeholder="python, javascript, react, AI" required>{{ ','.join(settings.get('search', {}).get('keywords', [])) }}</textarea>
            <small class="text-muted">Separe por vírgulas</small>
        </div>
        <div class="grid grid-3">
            <div class="form-group">
                <label>Máx. Artigos</label>
                <input type="number" name="max_articles" value="{{ settings.get('search', {}).get('max_articles', 2) }}" min="1" max="10">
            </div>
            <div class="form-group">
                <label>Idioma</label>
                <select name="language_preference">
                    <option value="both" {% if settings.get('search', {}).get('language_preference') == 'both' %}selected{% endif %}>Ambos</option>
                    <option value="pt" {% if settings.get('search', {}).get('language_preference') == 'pt' %}selected{% endif %}>Português</option>
                    <option value="en" {% if settings.get('search', {}).get('language_preference') == 'en' %}selected{% endif %}>Inglês</option>
                </select>
            </div>
            <div class="form-group">
                <label>Dias Recentes</label>
                <input type="number" name="recent_days" value="{{ settings.get('search', {}).get('recent_days', 30) }}" min="1" max="365">
            </div>
        </div>
    </div>

    <!-- Agendamento -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Agendamento</span>
        </div>
        <div class="grid grid-3">
            <div class="form-group">
                <label>Hora</label>
                <input type="number" name="schedule_hour" value="{{ settings.get('schedule', {}).get('hour', 8) }}" min="0" max="23">
            </div>
            <div class="form-group">
                <label>Minuto</label>
                <input type="number" name="schedule_minute" value="{{ settings.get('schedule', {}).get('minute', 0) }}" min="0" max="59">
            </div>
            <div class="form-group">
                <label>Fuso Horário</label>
                <select name="timezone">
                    <option value="America/Sao_Paulo" {% if settings.get('schedule', {}).get('timezone') == 'America/Sao_Paulo' %}selected{% endif %}>São Paulo</option>
                    <option value="America/New_York" {% if settings.get('schedule', {}).get('timezone') == 'America/New_York' %}selected{% endif %}>New York</option>
                    <option value="Europe/London" {% if settings.get('schedule', {}).get('timezone') == 'Europe/London' %}selected{% endif %}>London</option>
                    <option value="Asia/Tokyo" {% if settings.get('schedule', {}).get('timezone') == 'Asia/Tokyo' %}selected{% endif %}>Tokyo</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="schedule_enabled" {% if settings.get('schedule', {}).get('enabled', True) %}checked{% endif %}>
                Ativar agendamento automático
            </label>
        </div>
    </div>

    <!-- Automação -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Controle de Automação</span>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="automation_toggle" {% if automation_enabled %}checked{% endif %} onchange="toggleAutomation(this)">
                <strong>Automação Ativada</strong>
                <br>
                <small class="text-muted">Quando ativada, o sistema buscará e publicará artigos automaticamente</small>
            </label>
        </div>
    </div>

    <div class="btn-group">
        <button type="submit" class="btn btn-primary">Salvar Configurações</button>
        <button type="button" class="btn btn-secondary" onclick="testConnections()">Testar Conexões</button>
        <a href="/" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<!-- Modal simplificado -->
<div class="modal" id="testModal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">Teste de Conexão</span>
        </div>
        <div class="modal-body">
            <div id="testResults"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Fechar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testConnections() {
    const modal = document.getElementById('testModal');
    const resultsDiv = document.getElementById('testResults');
    
    resultsDiv.innerHTML = '<div class="loading">Testando conexões...</div>';
    modal.classList.add('active');
    
    fetch('/test-connection', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            let html = '<table>';
            html += `<tr><td>Medium API</td><td class="text-right">${data.medium ? '✅ Conectado' : '❌ Falhou'}</td></tr>`;
            html += `<tr><td>WordPress</td><td class="text-right">${data.wordpress ? '✅ Conectado' : '❌ Falhou'}</td></tr>`;
            html += '</table>';
            resultsDiv.innerHTML = html;
        })
        .catch(error => {
            resultsDiv.innerHTML = '<div class="alert alert-error">Erro ao testar conexões</div>';
        });
}

function closeModal() {
    document.getElementById('testModal').classList.remove('active');
}

function toggleAutomation(checkbox) {
    const enabled = checkbox.checked;
    
    fetch('/api/automation/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            checkbox.checked = !enabled;
            alert('Erro ao alterar automação');
        }
    })
    .catch(error => {
        checkbox.checked = !enabled;
        alert('Erro ao alterar automação');
    });
}
</script>
{% endblock %}